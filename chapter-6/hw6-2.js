use test
db.grades.aggregate([
	{$unwind: '$scores'},
	{$match: {
		'scores.type': {$ne: 'quiz'}
	}},
	{$group: {
		_id: {
			student_id: '$student_id',
			class_id: '$class_id'
		},
		avg: {$avg: '$scores.score'}
	}},
	{$group: {
		_id: '$_id.class_id',
		avg: {$avg: '$avg'}
	}},
	{$sort: {avg: -1}}
])
//{ "_id" : 1, "avg" : 64.50642324269175 }
//{ "_id" : 5, "avg" : 58.08448767613548 }
//{ "_id" : 20, "avg" : 57.6309834548989 }
//{ "_id" : 26, "avg" : 56.06918278769095 }
//{ "_id" : 9, "avg" : 55.56861693456625 }
//{ "_id" : 14, "avg" : 55.36017373346245 }
//{ "_id" : 24, "avg" : 53.6103459780166 }
//{ "_id" : 16, "avg" : 53.458335393624246 }
//{ "_id" : 13, "avg" : 52.738286239952366 }
//{ "_id" : 4, "avg" : 52.655415610658586 }
//{ "_id" : 17, "avg" : 52.4246917774609 }
//{ "_id" : 23, "avg" : 51.93284830763039 }
//{ "_id" : 3, "avg" : 51.7742498662982 }
//{ "_id" : 0, "avg" : 50.64317695848949 }
//{ "_id" : 19, "avg" : 50.590719286350925 }
//{ "_id" : 27, "avg" : 50.58111308566053 }
//{ "_id" : 11, "avg" : 49.95281236534422 }
//{ "_id" : 29, "avg" : 49.305440602697246 }
//{ "_id" : 7, "avg" : 48.87708798013475 }
//{ "_id" : 6, "avg" : 48.41485242956824 }
